{% extends 'common/base.html' %}
{% block title %}{{ table.name }} | DungeonFinder{% endblock %}
{% block content %}
<section class="table-view-section">
    <div class="table-block table-view-block">
        <div class="table-header">
            <h1>{{ table.name }}</h1>
        </div>
        {% if table.announcement %}
            <div class="ad-block table-details-announcement">
                <div class="announcement-title">
                    <strong>Announcement:</strong><br>
                </div>
                <div class="announcement-content">
                    {{ table.announcement|linebreaksbr }}
                </div>
            </div>
        {% endif %}
        <div class="table-main-content">
            <div class="table-members ad-block table-members-section">
                <h2>Members</h2>
                <div class="members-list">
                    <div class="member-block member-owner" style="background-color: {{ table.owner_color }};">
                        <a href="{% url 'account_details' table.created_by.pk %}" target="_blank" rel="noopener" class="member-link">
                            <img src="{{ table.created_by.profile.profile_pic.url }}" class="member-avatar" alt="{{ table.created_by.username }}">
                            <span class="member-username">{{ table.created_by.username }}</span>
                        </a>
                    </div>
                    {% for admin in table.admins.all %}
                        <div class="member-block member-admin" style="background-color: {{ table.admin_color }};">
                            <a href="{% url 'account_details' admin.pk %}" target="_blank" rel="noopener" class="member-link">
                                <img src="{{ admin.profile.profile_pic.url }}" class="member-avatar" alt="{{ admin.username }}">
                                <span class="member-username">{{ admin.username }}</span>
                            </a>
                        </div>
                    {% empty %}
                    {% endfor %}
                    {% for member in table.members.all %}
                        {% if member != table.created_by and member not in table.admins.all %}
                            <div class="member-block member-member" style="background-color: {{ table.member_color }};">
                                <a href="{% url 'account_details' member.pk %}" target="_blank" rel="noopener" class="member-link">
                                    <img src="{{ member.profile.profile_pic.url }}" class="member-avatar" alt="{{ member.username }}">
                                    <span class="member-username">{{ member.username }}</span>
                                </a>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="member-block member-none">
                            No members yet.
                        </div>
                    {% endfor %}
                </div>
                <div class="ad-actions table-details-actions">
                    {% if user.is_authenticated %}
                        {% if user == table.created_by %}
                            <a href="{% url 'manage_table' table.pk %}" class="btn btn-primary table-members-btn">Manage Table</a>
                        {% elif user in table.admins.all %}
                            <a href="{% url 'manage_table' table.pk %}" class="btn btn-primary table-members-btn">Manage Table</a>
                            <a href="{% url 'table_leave' table.pk %}" class="btn btn-primary table-members-btn">Leave Table</a>
                        {% elif user in table.members.all %}
                            <a href="{% url 'table_leave' table.pk %}" class="btn btn-primary table-members-btn">Leave Table</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="table-messages ad-block">
                <h2>Messages</h2>
                <div class="message-list-container">
                    <ul class="message-list">
                        {% for message in table.messages.all %}
                            <li class="message-block-content">
                                <span class="message-meta">
                                    <span>
                                        <strong class="message-sender-name">{{ message.sender.username }}</strong>
                                        <span class="message-time">({{ message.sent_at|date:"M d, Y H:i" }})</span>
                                    </span>
                                    {% if user.is_authenticated %}
                                        {% if message.sender == user or table.created_by == user or user in table.admins.all %}
                                            <form class="inline-message-delete-form" method="post" action="{% url 'delete_message' message.pk %}">
                                                {% csrf_token %}
                                                <button type="submit" class="message-delete-btn" title="Delete this message">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </span>
                                <div>{{ message.content|linebreaksbr }}</div>
                            </li>
                        {% empty %}
                            <li class="empty-messages-list">No messages yet.</li>
                        {% endfor %}
                    </ul>
                </div>
                {% if user.is_authenticated and user in table.members.all %}
                    <div class="message-form-container">
                        <h3 class="message-send-header">Post a Message</h3>
                        <form method="post" action="">
                            {% csrf_token %}
                            {{ form.as_p }}
                            <button type="submit" class="btn btn-primary">Send</button>
                        </form>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}