{% extends 'common/base.html' %}
{% block title %}My Applications | DungeonFinder{% endblock %}

{% block content %}
<div class="my-applications-section">
    <div class="applications-tabs">
        <a href="{% url 'my_applications' %}?type=received&page=1"
            class="btn tab-btn{% if view_type == 'received' %} active-tab{% endif %}">Received</a>
        <a href="{% url 'my_applications' %}?type=sent&page=1" 
            class="btn tab-btn{% if view_type == 'sent' %} active-tab{% endif %}">Sent</a>
    </div>
    <section class="ad-list" id="application-list">
    {% for app in applications %}
        <div class="ad-block">
            <div class="ad-header">
                <h2>{{ app.ad.title }}</h2>
                <span class="ad-date">{{ app.submitted_at|date:"M d, Y" }}</span>
            </div>
            <div class="ad-meta">
                {% if view_type == 'sent' %}
                    <span class="ad-creator"><strong>Recipient:</strong> {{ app.recipient.username }}</span>
                {% else %}
                    <span class="ad-creator"><strong>From:</strong> {{ app.owner.username }}</span>
                {% endif %}
                <span><strong>Status:</strong> {{ app.get_status_display }}</span>
                <span><strong>Role:</strong> {{ app.get_role_display }}</span>
                <span class="ad-location"><strong>Location:</strong> {{ app.ad.location_type }}</span>
            </div>
            <div class="ad-description">
                {{ app.message|truncatechars:220 }}
            </div>
            <div class="ad-actions">
                {% if app.invitation %}
                    {% if app.invitation.status == 'pending' and app.invitation.recipient == user %}
                        <form method="post" action="{% url 'accept_invitation' app.invitation.id %}" class="application-accept-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success" id="details-view-btn">Accept</button>
                        </form>
                        <form method="post" action="{% url 'decline_invitation' app.invitation.id %}" class="application-accept-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger" id="details-view-btn">Decline</button>
                        </form>
                    {% else %}
                        <span class="invitation-status">
                            Invitation {{ app.invitation.status|capfirst }}
                        </span>
                    {% endif %}
                {% else %}
                    <a href="{% url 'application_details' app.pk %}" class="btn btn-primary" id="details-view-btn">View Application</a>
                    <a href="{% url 'ad_details' app.ad.pk %}" class="btn btn-primary" id="details-view-btn">View Ad</a>
                {% endif %}
            </div>
        </div>
    {% empty %}
        <div class="ad-block">
            <p class="empty-applications-list-p">
                {% if view_type == 'sent' %}
                    You haven't sent any applications yet.
                {% else %}
                    You haven't received any applications yet.
                {% endif %}
            </p>
        </div>
    {% endfor %}
    </section>
</div>
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?type={{ view_type }}&page=1">&laquo; first</a>
        <a href="?type={{ view_type }}&page={{ page_obj.previous_page_number }}">previous</a>
    {% endif %}

    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
        <a href="?type={{ view_type }}&page={{ page_obj.next_page_number }}">next</a>
        <a href="?type={{ view_type }}&page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
    {% endif %}
</div>
{% endblock %}